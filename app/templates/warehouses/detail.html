{% extends "base.html" %}

{% block title %}Warehouse Details - Auto Parts Inventory{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/warehouses">Warehouses</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Warehouse Details</li>
                </ol>
            </nav>
        </div>
    </div>

    <div id="loading-state" class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading warehouse details...</p>
    </div>

    <div id="content" class="d-none">
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 id="warehouse-name"><i class="fas fa-warehouse me-2"></i></h1>
                        <p class="text-muted" id="warehouse-description"></p>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="#" id="edit-button" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                        <button class="btn btn-outline-success" onclick="showAddPartModal()">
                            <i class="fas fa-plus me-1"></i>Add Part
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteWarehouse()">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Warehouse Information -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Warehouse Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">Status:</dt>
                            <dd class="col-sm-7" id="warehouse-status">-</dd>
                            
                            <dt class="col-sm-5">Manager:</dt>
                            <dd class="col-sm-7" id="manager-name">-</dd>
                            
                            <dt class="col-sm-5">Phone:</dt>
                            <dd class="col-sm-7" id="manager-phone">-</dd>
                            
                            <dt class="col-sm-5">Email:</dt>
                            <dd class="col-sm-7" id="manager-email">-</dd>
                        </dl>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Location</h5>
                    </div>
                    <div class="card-body">
                        <address id="warehouse-address">
                            <div class="text-muted">Loading address...</div>
                        </address>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Capacity</h5>
                    </div>
                    <div class="card-body">
                        <div id="capacity-info">
                            <div class="text-muted">Loading capacity information...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory List -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory</h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" style="width: 200px;" 
                                   placeholder="Search parts..." id="inventory-search">
                            <button class="btn btn-outline-primary btn-sm" onclick="searchInventory()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Part Name</th>
                                        <th>Part Number</th>
                                        <th>Location</th>
                                        <th>Quantity</th>
                                        <th>Min. Stock</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body">
                                    <!-- Inventory will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="inventory-loading" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading inventory...</span>
                        </div>
                        
                        <div id="inventory-empty" class="text-center py-4 d-none">
                            <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                            <h6>No parts in this warehouse</h6>
                            <p class="text-muted">Start adding parts to track inventory.</p>
                            <button class="btn btn-primary" onclick="showAddPartModal()">
                                <i class="fas fa-plus me-1"></i>Add First Part
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Part Modal -->
<div class="modal fade" id="addPartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Part to Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-part-form">
                    <div class="mb-3">
                        <label for="part-select" class="form-label">Select Part</label>
                        <select class="form-select" id="part-select" name="part_id" required>
                            <option value="">Choose a part...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location in Warehouse</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               placeholder="e.g., A1-B2, Shelf 3, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addPartToWarehouse()">Add Part</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentWarehouseId = null;
let addPartModal = null;

document.addEventListener('DOMContentLoaded', function() {
    currentWarehouseId = getWarehouseIdFromUrl();
    if (currentWarehouseId) {
        loadWarehouseDetails(currentWarehouseId);
        loadInventory(currentWarehouseId);
        loadAvailableParts();
    }
    
    // Initialize modal
    addPartModal = new bootstrap.Modal(document.getElementById('addPartModal'));
    
    // Search handler
    document.getElementById('inventory-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchInventory();
        }
    });
});

function getWarehouseIdFromUrl() {
    const path = window.location.pathname;
    const matches = path.match(/\/warehouses\/(\d+)/);
    return matches ? parseInt(matches[1]) : null;
}

async function loadWarehouseDetails(warehouseId) {
    try {
        const response = await fetch(`/api/v1/warehouses/${warehouseId}`, {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const warehouse = await response.json();
            displayWarehouseDetails(warehouse);
            document.getElementById('loading-state').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');
        } else {
            throw new Error('Failed to load warehouse details');
        }
    } catch (error) {
        console.error('Error loading warehouse details:', error);
        showAlert('danger', 'Failed to load warehouse details');
    }
}

function displayWarehouseDetails(warehouse) {
    document.getElementById('warehouse-name').innerHTML = `<i class="fas fa-warehouse me-2"></i>${escapeHtml(warehouse.name)}`;
    document.getElementById('warehouse-description').textContent = warehouse.description || 'No description available';
    document.getElementById('edit-button').href = `/warehouses/${warehouse.id}/edit`;
    
    // Status badge
    const statusBadge = warehouse.is_active ? 
        '<span class="badge bg-success">Active</span>' : 
        '<span class="badge bg-secondary">Inactive</span>';
    document.getElementById('warehouse-status').innerHTML = statusBadge;
    
    // Manager information
    document.getElementById('manager-name').textContent = warehouse.manager_name || '-';
    document.getElementById('manager-phone').textContent = warehouse.manager_phone || '-';
    document.getElementById('manager-email').textContent = warehouse.manager_email || '-';
    
    // Address
    const addressElement = document.getElementById('warehouse-address');
    if (warehouse.address || warehouse.city || warehouse.state || warehouse.zip_code) {
        addressElement.innerHTML = `
            ${warehouse.address ? escapeHtml(warehouse.address) + '<br>' : ''}
            ${warehouse.city ? escapeHtml(warehouse.city) + ', ' : ''}
            ${warehouse.state ? escapeHtml(warehouse.state) + ' ' : ''}
            ${warehouse.zip_code ? escapeHtml(warehouse.zip_code) : ''}
        `;
    } else {
        addressElement.innerHTML = '<span class="text-muted">No address specified</span>';
    }
    
    // Capacity information
    const capacityElement = document.getElementById('capacity-info');
    if (warehouse.capacity) {
        const currentStock = warehouse.current_stock || 0;
        const utilizationPercent = Math.round((currentStock / warehouse.capacity) * 100);
        
        capacityElement.innerHTML = `
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span>Current Stock:</span>
                    <strong>${currentStock.toLocaleString()}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Capacity:</span>
                    <strong>${warehouse.capacity.toLocaleString()}</strong>
                </div>
            </div>
            <div class="progress mb-2">
                <div class="progress-bar ${utilizationPercent > 90 ? 'bg-danger' : utilizationPercent > 70 ? 'bg-warning' : 'bg-success'}" 
                     style="width: ${utilizationPercent}%"></div>
            </div>
            <small class="text-muted">Utilization: ${utilizationPercent}%</small>
        `;
    } else {
        capacityElement.innerHTML = '<span class="text-muted">Unlimited capacity</span>';
    }
}

async function loadInventory(warehouseId) {
    try {
        // Note: This would need a specific endpoint for warehouse inventory
        // For now, showing placeholder
        document.getElementById('inventory-loading').classList.add('d-none');
        document.getElementById('inventory-empty').classList.remove('d-none');
    } catch (error) {
        console.error('Error loading inventory:', error);
    }
}

async function loadAvailableParts() {
    try {
        const response = await fetch('/api/v1/parts', {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const parts = await response.json();
            const select = document.getElementById('part-select');
            select.innerHTML = '<option value="">Choose a part...</option>';
            
            parts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = `${part.name} (${part.part_number || 'No P/N'})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading parts:', error);
    }
}

function showAddPartModal() {
    addPartModal.show();
}

async function addPartToWarehouse() {
    const form = document.getElementById('add-part-form');
    const formData = new FormData(form);
    
    const data = {
        part_id: parseInt(formData.get('part_id')),
        quantity: parseInt(formData.get('quantity')),
        location: formData.get('location')
    };
    
    if (!data.part_id || !data.quantity) {
        showAlert('warning', 'Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/warehouses/${currentWarehouseId}/parts`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showAlert('success', 'Part added to warehouse successfully');
            addPartModal.hide();
            form.reset();
            loadInventory(currentWarehouseId);
            loadWarehouseDetails(currentWarehouseId); // Refresh capacity info
        } else {
            const error = await response.json();
            showAlert('danger', error.detail || 'Failed to add part to warehouse');
        }
    } catch (error) {
        console.error('Error adding part to warehouse:', error);
        showAlert('danger', 'Failed to add part to warehouse');
    }
}

function searchInventory() {
    const query = document.getElementById('inventory-search').value;
    // Implement search functionality
    console.log('Searching inventory for:', query);
}

async function deleteWarehouse() {
    if (!confirm('Are you sure you want to delete this warehouse? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/warehouses/${currentWarehouseId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            showAlert('success', 'Warehouse deleted successfully');
            window.location.href = '/warehouses';
        } else {
            throw new Error('Failed to delete warehouse');
        }
    } catch (error) {
        console.error('Error deleting warehouse:', error);
        showAlert('danger', 'Failed to delete warehouse');
    }
}
</script>
{% endblock %}
